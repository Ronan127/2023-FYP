\chapter{Maths Model}

\section{Overview and objectives}

This project develops a system of equations to analytically model the climbing motion of the device, which will be referred to as the, "Maths Model" henceforth. The intention behind this model is to allow designers to input parameters such as gear ratio, mass, wheel size, tail length, and motor torque, then determine whether the specified device will be able to climb steps. The equations can also reversed to solve for specific parameters, such as the motor torque required to lift a device with certain properties. The maths model is developed using the MATLAB symbolic toolbox.\\

\section{Definition of motions}

As a LIMed device climbs, the tail and wheels come into contact with different surfaces on the stairs and ground, which changes how the device moves. The overall climbing motion is broken down into sequential stages which are modelled individually. These stages are defined as follows:\\
\subsection*{Stage 0: Rolling}

When the LIMed device does is on a flat plane with no obstacle, it simply rolls forward. If the motor torque is high enough, the LIMs will flip even without an obstacle. However, DC motors lose torque as they gain speed, so the rolling motion prevents the motors from producing enough torque to flip the LIMs.\\

\subsection*{Stage 1: Lifting}
When the front wheel of the LIM comes into contact with the first step, it is blocked by a step and fixed in place. The tail pushes against the ground and the LIM starts rotating up the step. This motion ends when the LIM is vertical.
\\
\subsection*{Stage 2: Flipping}

Once the LIM is vertical, the bottom wheel starts to roll backwards as the top wheel falls forward onto the step. The distance that the bottom wheel rolls depends on the speed of the LIM and the height of the step. If the frame of the LIM hits the edge of the step, the device may slip backwards until the top wheel makes contact with the step. This motion ends when the top wheel is on the step.\\

\subsection*{Stage 3: Climbing}

The front wheel rests on the step while the back wheel is on the ground. The tail pushes against the ground and the back wheel lifts while the front wheel simultaneously rolls forward on the step. This motion ends when the front wheel reaches the next step.\\

Stages 1 to 3 will repeat until the tail leaves the ground. After this point the tail will push against the edge of the previous steps. 

\subsection*{Stage 4: Lifting from step}

Similar to Stage 1, but the tail pushes against the edge of a the previous step, which now applies a force pulling the device backwards. Assuming friction on the wheel is sufficient, the LIM starts rotating up the step. This motion ends when the LIM is vertical.

\subsection*{Stage 5: Flipping from step}

Similar to Stage 2, but the tail pushes against the edge of a the previous step, which now applies a force pulling the device backwards. This motion ends when the top wheel is on the step.\\

\subsection*{Stage 6: Climbing from step}

Similar to Stage 3, but the tail pushes against the edge of a the previous step, which now applies a force pulling the device backwards. The back wheel lifts while the front wheel rolls forward on the step. This motion ends when the front wheel reaches the next step; however, due to the tail force pulling the device backwards, the back wheel will continue to lift past the horizontal while front wheel rolls forward.\\


\section{Core equations and assumptions}

The maths model is consists of a system of equations that are solved simultaneously. These equations are derived from the free body diagrams of each component, and only consider movement in two dimensions. The components in question are the LIM frame, the sun gear, the idler gears, and the planet gears including the shaft and the wheels, and the body of the device. These components make contact with the surroundings and the other components, which exert equal and opposite forces on each other. As the maths model only considers movement in two dimensions, the LIMs are assumed to move synchronously. To simplify the equations, only one LIM is modelled, and its mass and moment of inertia is doubled.\\

Consider the device climbing a step as visualised in Figure \ref{Component-names}. Each component is assigned a number, where the LIM frame is 1, the sun gear is 2, the idler gears are 3 and 4, the planet gears, including the wheels, are 5 and 6, and the body of the device, including the tail, is 7.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{FBDs/Naming components.png}
	\caption{Free body diagram of the LIM frame (component 1)}
	\label{Component-names}
\end{figure}
Powering the motor causes a torque between the body of the device and the SUN gear. The device will also  be subject to external reaction forces where it contacts the environment, which are dependent on the stage of motion. These forces and torques will propagate internally through the gears, causing a forward motion. The free body diagrams for each component are shown in Figures \ref{FBD-1} and \ref{FBD-2}.\\
\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{FBDs/FBD-1.png}
	\caption{Free body diagram of the LIM frame (component 1)}
	\label{FBD-1}
\end{figure}
\begin{figure}[!h]
	\centering
	\includegraphics[width=1\textwidth]{FBDs/FBD-2.png}
	\caption{Free body diagram of the gears (components 2-5)}
	\label{FBD-2}
\end{figure}

Each component exerts a force on connected components, which exert an equal and opposite force back.
For example, the the sum of forces equations for the sun gear are,\\
\begin{equation}
	m_2\vec{a_2} == \vec{w_2}-\vec{f_2}+\vec{\mathrm{gf}_3}+\vec{\mathrm{gf}_4}
\end{equation}
Where $m_x$ refers to the mass of component $x$, $\vec{a_x}$ is the acceleration vector of component $x$, $\vec{w_x}$ is the weight vector of component $x$, $\vec{f_x}$ is the force vector that component $x$ applies to component 1,  and $\vec{\mathrm{gf}_3}$ and $\vec{\mathrm{gf}_4}$ are the force vectors that components 3 and 4 respectively apply to component 2 through the gears.
This can be expanded to,
\begin{equation}
	m_2
	\begin{bmatrix}
		a_{21}\\
		a_{22}\\
		a_{23}\\
	\end{bmatrix}
	=
	\begin{bmatrix}
		w_{21}-f_{21}+\mathrm{gf}_{31}+\mathrm{gf}_{41}\\
		w_{22}-f_{22}+\mathrm{gf}_{32}+\mathrm{gf}_{42}\\
		w_{23}-f_{23}+\mathrm{gf}_{33}+\mathrm{gf}_{43}\\
	\end{bmatrix}
\end{equation}
where vector positions 1, 2, and 3 denote the x, y, and z dimensions respectively. This equation can be further simplified by restraining movement to the x and y dimensions, and substituting $\vec{w_2} = \begin{bmatrix} 0 & m_2g & 0 \end{bmatrix}'$,
\begin{equation}
	m_2
	\begin{bmatrix}
		a_{21}\\
		a_{22}\\
	\end{bmatrix}
	=
	\begin{bmatrix}
		-f_{21}+\mathrm{gf}_{31}+\mathrm{gf}_{41}\\
		m_2g-f_{22}+\mathrm{gf}_{32}+\mathrm{gf}_{42}\\
	\end{bmatrix}
\end{equation}
Similarly, the sum of moments equation for the sun gear is derived
\begin{equation}
	I_2\ddot{\theta_2} == T - r_2|\vec{\mathrm{gf}_3}| + r_2|\vec{\mathrm{gf}_3}|
\end{equation}
where $I_2$ is the moment of inertia of component 2, $\theta_2$ is the angle of component 2, $T$ is the moment exerted by the motor on component 2, and $r_2$ is the radius of component 2. Note that in this project, all angles and moments are given in the clockwise direction.
\\
The full list of equations can be found in appendix ??? and in the matlab code.



\section{Boundary conditions}
Depending on the stage of the climbing, components of the device will come into contact with different parts of the steps and at different angles. To model climbing in each stage, a set of equations defining the contact is given for each stage.\\
\subsection*{Stage 1: Lifting}
The front wheel, referred to as component 5, is locked in place by the reaction forces from the step, this leads to the condition,
\begin{subequations}
	\label{wheel1locked}
	\begin{align}
		\vec{a_5} &= \vec{0}\\
		\vec{v_5} &= \vec{0}\\
		\dot{\theta}_5 &= 0\\
		\ddot{\theta}_5 &= 0
	\end{align}
\end{subequations}
where $\vec{v_x}$ refers to the velocity of component $x$.\\
The front wheel must be placed into a two dimensional coordinate system. In stage 1, the front wheel can be on the ground or on one of the steps, so long as the tail can reach the ground, and the front wheel will always be pressed against the edge of the next step. Placing the origin at the start of the steps as seen in Figure ???, the position of the wheel can be defined as,
\begin{equation}
	\vec{s_5}
	=
	\begin{bmatrix}
		\mathrm{StepWidth}\cdot N-r_w\\
		\mathrm{StepHeight}\cdot N+r_w\\
		0
	\end{bmatrix}
\end{equation}
where $\vec{s_5}$ is the position vector of the centre of the front wheel, $N$ is the number of the step on which the wheel is placed, with $N = 0$ placing the step on the ground, and $r_w$ is the radius of the wheel.\\
The end of the tail pushes against the ground, which leads to the following conditions,
\begin{subequations}
	\label{tailonground}
	\begin{align}
		s_{7end2} &= 0\\
		F_{react71} &=  -\mu_{tail}F_{react72}\\
		-\ddot{\theta_7} &= \frac{(|\vec{l_7}|^2 - l_{72}^2)a_{12} + l_{72}v_{12}^2}{|\vec{l_7}|^3 (1 - \frac{l_{72}^2}{|\vec{l_7}|^2})^{3/2}} \label{tailongroundkinematics}
	\end{align}
\end{subequations}
where $s_{7end2}$ is the y position of the endpoint of the tail, $F_{react71}$ and $F_{react72}$ are the reaction forces exerted onto the tail by the ground in the x and y dimensions respectively, $\mu_{tail}$ is the coefficient of friction between the tail and the ground, $\vec{l_7}$ is the position of the end of the tail relative to the motor axle, and $l_{72}$ is the component of $\vec{l_7}$ in the y dimension. \\
Equation \ref{tailongroundkinematics} is derived from,

\begin{subequations}
	\begin{align}
		-\theta_7(t) &= \arcsin{\frac{l_{72}(t)}{|\vec{l_7}|}}\\
		\frac{d^2}{dt^2}-\theta_7(t) &= \frac{d^2}{dt^2}\arcsin{\frac{l_{72}(t)}{|\vec{l_7}|}}
	\end{align}
\end{subequations}
where $\theta_7$ and $l_{72}$ are treated as functions of time, $t$. This relation can be seen in figure ???. $v_{12}$ and $a_{12}$ refer to the velocity and acceleration of the motor axle in the y dimension, and are equivalent to $\dot{l}_{72}$ and $\ddot{l}_{72}$ respectively.\\ ??????? verify

\subsection*{Stage 2: Flipping}

Once the LIM is vertical, there is no longer a force pushing the bottom wheel forward into the step, instead it rolls backwards. This leads to a new condition,
\begin{subequations}
	\label{wheel1rolling}
	\begin{align}
		\vec{a_5} &= \begin{bmatrix}
			\ddot{\theta}_5 r_w \\
			0\\
			0
		\end{bmatrix}\\
		\vec{v_5} &= \begin{bmatrix}
			\dot{\theta}_5 r_w \\
			0\\
			0
		\end{bmatrix}\\
		s_{51} &= \theta_{5} r_w;\\
		M_{react5} &= - F_{react51} r_w;
	\end{align}
\end{subequations}
where $M_{react5}$ is the reaction moment on wheel 5 as a result of the reaction forces.
The tail is still on the ground, so will still be subject to Equations \ref{tailonground}.

\subsection*{Stage 3: Climbing}

In Stage 3, the front and back wheel have swapped. To simplify the movements, component 5 will always refer to the wheel that makes contact with the steps, and component 6 will refer to the wheel that does not. \\
The front wheel is rolling and the tail is on the ground, which are the same conditions as in Stage 2. As such, Stage 3 is subject to Equations \ref{wheel1rolling} and \ref{tailonground}.

\subsection*{Stage 4: Lifting with tail on step}
Stage 4 is similar to stage 1, except the tail is on the step. As such, this motion is subject to Equations \ref{wheel1locked} because the wheel is locked, and a set of new conditions because the tail is on the edge of the step,

\begin{subequations}
	\label{tailonstep}
	\begin{align}
		u_1 &= \mathrm{StepWidth}\cdot (N_2-1)- s_{11}\\
		u_2 &= \mathrm{StepHeight}\cdot N_2 - s_{12}\\
		\tan{-\theta_7} &= \frac{u_2}{u_1}\\
		\label{tailonstepposition}
		-\ddot{\theta_7} &= \frac{u_2^2 (-2  v_{11}  v_{12} - u_2  a_{11}) + u_1^2 (2  v_{11}  v_{12} + -u_2 a_{11}) + u_1^3  a_{12} - u_1  u_2  (2 v_{12}^2 - 2  v_{11}^2 - u_2  a_{12})}{(u_1^2 + u_2^2)^2}\\
		\label{tailonstepaccelleration}
		F_{react71}' &= -\mu_{tail} F_{react72}'\\
		\vec{F}_{react7} &= \begin{bmatrix}
			-\cos{(\theta_7)} & -\sin{(\theta_7)} & 0\\
			\sin{(\theta_7)} & -\cos{(\theta_7)} & 0\\
			0 & 0 & 1
		\end{bmatrix} \vec{F}_{react71}'
	\end{align}
\end{subequations}
where $N_2$ is the number of the step that the tail makes contact with, $u_1$ and $u_2$ are the displacement from the motor axis to the point of contact with the step. Equation \ref{tailonstepaccelleration} is the second derivative of \ref{tailonstepposition}. $\vec{F}_{react71}'$ is the vector of reaction forces in a rotated coordinate system such that $F_{react72}'$ is the normal force between the tail and the step.

\subsection*{Stage 5: Flipping from step}
Stage 5 is similar to stage 2, except the tail is on the step. As such, this motion is subject to Equations \ref{wheel1rolling} because the wheel is locked, and Equations \ref{tailonstep} because the tail is on the step.\\

\subsection*{Stage 6: Climbing from step}
Stage 6 is similar to stage 3, except the tail is on the step. As such, this motion is subject to Equations \ref{wheel1rolling} because the wheel is locked, and Equations \ref{tailonstep} because the tail is on the step.\\

\section{Solving technique}
The MATLAB symbolic toolbox comes with the solve() function, which can be used to solve sets of non-linear simultaneous equations. However, it struggles with this large set of equations that contain trigonometric functions, often stalling. This project develops a function that breaks down the set of equations into smaller, easier to solve sets, then substituting these solutions into the remaining equations. Figure ??? shows the flowchart for this function. \\
\\
The function loops through the equations until they have all been solved, or it cannot find any more solutions. First, it identifies any trivial equations that contain only one variable, such as $a = 1$, and solves them. This will also pick up equations with more than one solution, such as $\sin{a} = 1$; to resolve this, the solver will look for inequalities that contain the relevant variable, in this case $a$, and apply them to the solution. For example, if you were to provide the function with the set of equations:\\

\begin{subequations}
	\label{exampleinput}
	\begin{align}
		a &= 0.5 \label{example1a}\\
		\sin{(b)} &= a\\
		b &>= \frac{\pi}{2}\\
		b &<= \pi
	\end{align}
\end{subequations}
The first loop would identify Equation \ref{example1a} as it only has one variable. It wouldn't find any inequalities that describe the variable $a$ so it would simply send the equation $a = 0.5$ to MATLAB's solve() function. It then records the solution and substitutes it into the remaining equations, 
\begin{subequations}
	\label{example2}
	\begin{align}
		\sin{(b)} &= 0.5 \label{example2a}\\
		b &>= \frac{\pi}{2}\label{example2b}\\
		b &<= \pi\label{example2c}
	\end{align}
\end{subequations}
The second loop identifies Equation \ref{example2a} as it only has one variable. It looks for inequalities that describe $b$ and finds Inequalities \ref{example2b} and \ref{example2c}. It then sends all three to MATLAB's solve() function, which returns the solution for $b$.
The function then outputs a structure with the fields,
\begin{subequations}
	\begin{align}
		\mathrm{solution.a} &= 0.5\\
		\mathrm{solution.b} &= \frac{5\pi}{6}
	\end{align}
\end{subequations}

Once the function can no longer find trivial solutions, it looks for sets of equations that contain the exact same variables, such as equations of the form,
\begin{subequations}
	\begin{align}
		a -2b &= 0\\
		b -a +2 &= 0 
	\end{align}
\end{subequations}
and sends them to be solved. For this to work, there must be at least as many equations as there are variables in the set. This function will also identify and delete duplicate equations.\\
Once the function can no longer find sets of equations that use the exact same variables, it will attempt to find sets of equations that fully describe a set of variables, such as,
\begin{subequations}
	\begin{align}
		a -3b &= 0\\
		b -c +2&= 0\\
		a -2c &= 0
	\end{align}
\end{subequations}
Finally, if it can't find any fully defined sets up to a certain size, it will attempt to solve the complete set of remaining equation using the solve() function. If the function is unable to solve all the equations, it will return a structure containing the solutions it has found, and a vector containing the remaining equations.


\section{Required torque}
When designing a LIM robot, it is essential to size the motor and gearbox to be able to provide enough torque to lift the LIMs. To do this, one must first determine which stage of motion requires the most torque. To find the minimum torque required to cause forward movement, we solve for the torque that results in an overall acceleration of 0 when the velocity is also 0, essentially adding the conditions:
\begin{subequations}
	\label{condition-static}
	\begin{align}
		\vec{a} &= \vec{0}\\
		\vec{v} &= \vec{0}\\
		\ddot{\theta_1} &= 0\\
		\dot{\theta_1} &= 0\\
	\end{align}
\end{subequations}
which simplifies the dynamic equations into static equations.\\
The set of equations is then solved for a range of positions in each stage.
\subsection*{Stage 1: Lifting}
During the lifting motion, the angle of the LIMs, $\theta_1$, increases from 0° when the LIM is horizontal to 90° when the LIM is vertical. Figure \ref{torque-angle-relation-stage1} shows that the required torque is highest when the LIM is horizontal, which in this particular device is 1.014 Nm, or 0.507 Nm per motor.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{plots/torque-angle-relation-stage1}
	\caption{Relationship between LIM angle and required torque for Stage 1 motion}
	\label{torque-angle-relation-stage1}
\end{figure}
\subsection*{Stage 2: Flipping}
During the flipping motion, the device does not need any torque to move. Even without a torque input, it will simply fall onto the next step.

\subsection*{Stage 3: Climbing}
During the climbing motion, the LIMs lift from the starting position, in this case -42.5° to the horizontal 0°. In addition, the front wheel can roll forward, instead of solving for the torque that results in an overall forward acceleration, we solve for the torque that causes a positive vertical acceleration in the back wheel. Instead of Equations \ref{condition-static}, we have:
\begin{subequations}
	\label{condition-climbing}
	\begin{align}
		a_{62} &= 0\\
		\vec{v} &= \vec{0}\\
		\dot{\theta_1} &= 0\\
	\end{align}
\end{subequations}
Figure \ref{torque-angle-relation-stage3} shows that the required torque increases as the LIM lifts, until the maximum of 0.970 Nm, or 0.485 Nm per motor when the LIM is horizontal.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{plots/torque-angle-relation-stage3}
	\caption{Relationship between LIM angle and required torque for Stage 3 motion}
	\label{torque-angle-relation-stage3}
\end{figure}

\subsection*{Stage 4: Lifting from step}
Similar to Stage 1, $\theta_1$ increases from 0° when the LIM is horizontal to 90° when the LIM is vertical. Figure \ref{torque-angle-relation-stage4} shows that for this device, the required torque is highest when the LIM is at 26.4°, which gives a required torque of 1.295 Nm, or 0.647 Nm per motor.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{plots/torque-angle-relation-stage4}
	\caption{Relationship between LIM angle and required torque for Stage 4 motion}
	\label{torque-angle-relation-stage4}
\end{figure}


\subsection*{Stage 5: Flipping from step}
During the flipping motion, the device does not need any torque to move. Even without a torque input, it will simply fall onto the next step.

\subsection*{Stage 6: Climbing from step}
Similar to Stage 3, $\theta_1$ increases from -42.5° to 0°, and Equations \ref{condition-climbing} are used instead of Equations \ref{condition-static}. Figure \ref{torque-angle-relation-stage6} shows that for this device, the required torque is highest when the LIM is horizontal, which gives a required torque of 1.228 Nm, or 0.614 Nm per motor.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{plots/torque-angle-relation-stage6}
	\caption{Relationship between LIM angle and required torque for Stage 6 motion}
	\label{torque-angle-relation-stage6}
\end{figure}
These plots show that the highest required torques will be in Stages 4 and 6, and that the particular device modelled requires an output torque of at least 0.647 Nm on each motor.

\subsection{Sizing components to reduce torque requirement}
So far this section has only modelled a device with fixed parameters, such as gear ratio, wheel size, mass, and tail length, however a designer may be interested in varying these parameters. The model can be used to inform the design process by showing the effect that changing certain parameters has on the required torque. For example, Figure ??? shows how changing the gear ratio affects the torque required.


\section{Required coefficient of friction}

When the device climbs steps, it is possible that the front wheel, component 5, will slip. Applying the coulomb approximation of friction to the model, Slipping will occur when $|F_{51}| > \mu_5 F_{52}$, where $\mu_5$ is the coefficient of friction between the wheel and the step. This coefficient can be increased by using certain materials, such as rubber, for the contact surface of the wheels. However, the coefficient of friction is also dependent on the material of the step itself, which a designer would not have control over. For this reason, designers may want to modify the design to reduce the required coefficient of friction.\\
Similar to the required torque, the coefficient of friction required to prevent slipping can also be calculated across the motion, and the highest value is in Stage 4. The parameters can be 
